<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=8.0, user-scalable=yes" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <title></title>
    <style>
    th, td {
        text-align: center;
        vertical-align: middle;
    }
    html, body, table.init {
        font-size: 2vmax;
        height: 100%;
    }
    table.init td {
        font-size: x-large;
    }
    body {
        margin: 0;
        background-image: linear-gradient(wheat, white);
        background-attachment: fixed;
        font-family: Arial;
    }
    table {
        padding: 6vmax;
        width: 100%;
        cursor: default;
    }
    table.seats {
        table-layout: fixed;
        border-spacing: 0;
    }
    table.seats div {
        position: relative;
        width: 100%;
        padding-bottom: 100%;
    }
    table.seats span {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    td.rownum {
        font-size: 1.8vmax;
        font-style: italic;
    }
    td.row {
        border-bottom: 1px solid #aaa;
    }
    td.seat span {
        border-radius: 0.7vmax;
        //color: white;
        background-image: linear-gradient(white, wheat);
    }
    td.seat.selected span {
        background-image: linear-gradient(#ff0, #ffe);
        border: 1px solid black;
    }
    td.seat span:hover {
        color: white;
        background: #444;
    }
    td.seat.held span {
        color: black;
        background: lightgray;
    }
    div.top {
	    position: fixed;
	    width: 100%;
	    height: 7vmax;
	    padding: 1vmax;
	    background: #ffd;
		border-bottom: 1px solid black;
		z-index: 10;
    }
    div.top button {
        font-size: 1.8vmax;
        float: right;
        margin-right: 2vmax;
        min-width: 20vmax;
        min-height: 7vmax;
    }
    div.top p {
        font-size: 1.8vmax;
    }
    </style>
    <script type="text/javascript">
    function addCell(text) {
      const td = document.createElement('td');
      const div = document.createElement('div');
      const span = document.createElement('span');
      span.textContent = text;
      div.appendChild(span);
      td.appendChild(div);
      return td;
    }
    function updateSelected() {
      const pr = document.getElementById('selection');

      const sel = document.getElementsByClassName('selected');
      if (sel.length == 0) {
        pr.textContent = '–ú–µ—Å—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
        return;
      }

      var text = [];
      for (var i = 0; i < sel.length; i++) {
        text.push(`—Ä—è–¥ ${sel[i].getAttribute('data-row')} –º–µ—Å—Ç–æ ${sel[i].textContent}`);
      }
      pr.textContent = '–í—ã–±—Ä–∞–Ω—ã –º–µ—Å—Ç–∞: ' + text.join(', ');
    }
    function doSelect(e) {
      const td = e.currentTarget;
      if (td.classList.contains('selected'))
        td.classList.remove('selected');
      else {
        if (startParam.maxsel) {
          const sel = document.getElementsByClassName('selected');
          if (sel.length >= startParam.maxsel)
            return;
        }
        td.classList.add('selected');
      }
      updateSelected();
    }
    function submitSelection() {
      const sel = document.getElementsByClassName('selected');

      var data = [];
      for (var i = 0; i < sel.length; i++) {
        data.push(sel[i].getAttribute('data-id'));
      }

      Telegram.WebApp.sendData(data.join(','));
    }
    function displaySeats() {
      document.getElementsByTagName('body')[0].innerHTML = '';
      const table = document.createElement('table');
      const tbody = document.createElement('tbody');
      table.classList.add('seats');
      table.appendChild(tbody);

      var scheme = startParam.seats, width = 0, rows = 0, total = 0;
      scheme = scheme.split("\n");
      for (let i in scheme)
        width = Math.max(width, scheme[i].length);
      for (let i in scheme) {
        const tr = document.createElement('tr');
        var count = 0;
        if (scheme[i].length < width)
          scheme[i] = scheme[i].padEnd(width);
        for (let j in scheme[i]) {
          const td = addCell(scheme[i][j] == ' ' ? ' ' : ''+count);
          if (scheme[i][j] != ' ') {
            td.classList.add('seat');
            if (scheme[i][j] == 'S')
              td.classList.add('selected');
            else if (scheme[i][j] == 'H')
              td.classList.add('held');
            td.setAttribute('data-id', total++);
            if (scheme[i][j] == 'x' || scheme[i][j] == 'S')
              td.addEventListener("click", doSelect);
            count++;
          }
          tr.appendChild(td);
        }
        if (count) {
          var td = addCell(' ');
          td.classList.add('row');
          tr.prepend(td);
          td = addCell('–†—è–¥¬†'+(rows+1));
          td.classList.add('row', 'rownum');
          tr.prepend(td);
          var st = tr.children;
          for (var j = 0; j < st.length; j++) {
            var n = parseInt(st[j].children[0].children[0].textContent);
            if (!isNaN(n)) {
              st[j].children[0].children[0].textContent = ''+(count - n);
              st[j].setAttribute('data-row', rows+1);
            }
            st[j].classList.add('row');
          }
          td = addCell(' ');
          td.classList.add('row');
          tr.appendChild(td);
          td = addCell('–†—è–¥¬†'+(rows+1));
          td.classList.add('row', 'rownum');
          tr.appendChild(td);
          rows++;
        }
        tbody.appendChild(tr);
      }

      const div = document.createElement('div');
      const btn = document.createElement('button');
      const pr = document.createElement('p');
      div.classList.add('top');
      div.textContent = (startParam.reserve ? 'üí∫ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç –≤ –∑–∞–ª–µ' : 'üí∫ –í—ã–±–æ—Ä –º–µ—Å—Ç –≤ –∑–∞–ª–µ');
      btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
      btn.addEventListener("click", submitSelection);
      div.appendChild(btn);
      pr.setAttribute('id', 'selection');
      div.appendChild(pr);

      document.body.appendChild(div);
      document.body.appendChild(table);
      updateSelected();
    }
    function onWindowLoad() {
        window.startParam = (new URLSearchParams(location.hash.substr(1))).get("tgWebAppStartParam");
        startParam = JSON.parse(atob(startParam));

        if (startParam.seats)
          displaySeats();
    }
    </script>
</head>

<body onload="onWindowLoad()">

<table class="init">
  <tr>
    <td>
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </td>
  </tr>
</table>

</body>
</html>
