<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=8.0, user-scalable=yes" />
    <meta name="robots" content="noindex,nofollow" />
    <script src="https://telegram.org/js/telegram-web-app.js?2"></script>
    <title></title>
    <style>
    th, td {
        text-align: center;
        vertical-align: middle;
    }
    html, body, table.init {
        font-size: 2vmax;
        height: 100%;
    }
    table.init td {
        font-size: x-large;
    }
    body {
        margin: 0;
        background-image: linear-gradient(wheat, white);
        background-attachment: fixed;
        font-family: Arial;
        display: flex;
        flex-direction: column;
        scrollbar-color: wheat #ffd;
    }
    table {
        width: 100%;
        cursor: default;
    }
    table.seats {
        display: inline-table;
        table-layout: fixed;
        padding: 0vmax 2vmax 0vmax 2vmax;
        border-spacing: 0;
    }
    table.seats div {
        position: relative;
        width: 100%;
        padding-bottom: 100%;
    }
    table.seats span {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    table.seats span.wall {
        background-image: url(Hexagon.svg);
        background-size: 100% auto;
        background-position: center;
        background-repeat: no-repeat;
    }
    td.rownum, td.rownumtitle {
        font-size: 1.8vmax;
        font-style: italic;
    }
    td.rownumtitle {
        vertical-align: bottom;
    }
    td.row {
        border-bottom: 1px solid #aaa;
    }
    td.seat span {
        border-radius: 0.7vmax;
        background-image: linear-gradient(white, wheat);
    }
    td.seat.selected span {
        background-image: linear-gradient(#ff0, #ffe);
        border: 1px solid black;
    }
    td.seat span:hover {
        color: white;
        background: #444;
    }
    td.seat.held span {
        color: black;
        background: lightgray;
    }
    div.wrapper {
        flex: 1;
        overflow: auto;
        width: 100%;
        height: 100%;
        text-align: center;
        position: relative;
    }
    div.top {
        min-height: 7vmax;
        padding: 1vmax;
        background: #ffd;
        border-bottom: 1px solid black;
    }
    div.top select {
        margin-left: 3vmax;
        font-size: 2vmax;
    }
    div.top button {
        font-size: 2.6vmax;
        float: right;
        min-width: 20vmax;
        min-height: 7vmax;
        background: #00b;
        color: white;
        border: unset;
        border-radius: 0.7vmax;
    }
    div.top p {
        font-size: 1.8vmax;
        margin-bottom: 0;
    }
    div.scene {
        display: flex;
        align-items: center;
        justify-content: center;
        background: #eee;
        font-size: 4vmax;
        font-style: italic;
        border: 1px solid;
        border-top: unset;
        margin-left: 6vmax;
        height: 10vmax;
    }
    div.sound {
        position: absolute;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #eee;
        font-size: 3vmax;
        font-style: italic;
        border: 1px solid;
    }
    </style>
    <script type="text/javascript">
    function addCell(text) {
      const td = document.createElement('td');
      const div = document.createElement('div');
      const span = document.createElement('span');
      span.textContent = text;
      div.appendChild(span);
      td.appendChild(div);
      return td;
    }
    function updateSelected() {
      const pr = document.getElementById('selection');
      const daysel = document.getElementById('day') ? parseInt(document.getElementById('day').value) : -1;

      const seat = document.getElementsByClassName('seat');
      for (const s of seat) {
        s.classList.remove('selected');
        s.classList.remove('held');
        s.addEventListener("click", doSelect);
      }

      for (let [key, value] of startParam.held) {
        if (daysel > -1 && !value.includes(daysel))
          continue;
        var el = document.querySelector(`[data-id="${key}"]`);
        el.classList.add('held');
        el.removeEventListener("click", doSelect);
      }

      if (startParam.sel.size == 0) {
        pr.textContent = '–ú–µ—Å—Ç–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω—ã';
        return;
      }

      var text = [];
      for (let [key, value] of startParam.sel) {
        var el = document.querySelector(`[data-id="${key}"]`);
        var st = `—Ä—è–¥ ${el.getAttribute('data-row')} –º–µ—Å—Ç–æ ${el.textContent}`;
        if (value.length < startParam.seats.length) {
          var days = [];
          for (var j = 0; j < value.length; j++)
            days.push(value[j] + 1);
          st += ` (–¥–µ–Ω—å ${days.join(', ')})`;
        }
        text.push(st);
        if (daysel > -1 && !value.includes(daysel))
          continue;
        el.classList.add('selected');
      }
      pr.textContent = '–í—ã–±—Ä–∞–Ω—ã –º–µ—Å—Ç–∞: ' + text.join(', ');
    }
    function doSelect(e) {
      const td = e.currentTarget;
      const id = parseInt(td.getAttribute('data-id'));
      const daysel = document.getElementById('day') ? parseInt(document.getElementById('day').value) : -1;

      if (startParam.sel.has(id) && (daysel == -1 || startParam.sel.get(id).includes(daysel))) {
        if (daysel == -1)
          startParam.sel.delete(id);
        else {
          startParam.sel.get(id).splice(startParam.sel.get(id).indexOf(daysel), 1);
          if (!startParam.sel.get(id).length)
            startParam.sel.delete(id);
        }
      } else {
        if (startParam.maxsel) {
          var sel = 0;
          for (let [key, value] of startParam.sel) {
            if (daysel > -1 && !value.includes(daysel))
              continue;
            sel++;
          }
          if (sel >= startParam.maxsel)
            return;
        }
        if (daysel == -1) {
          var sel = [];
          for (var i = 0; i < startParam.seats.length; i++)
            sel.push(i);
          startParam.sel.set(id, sel);
        } else {
          if (startParam.sel.has(id))
            startParam.sel.get(id).push(daysel);
          else
            startParam.sel.set(id, [daysel]);
        }
      }
      updateSelected();
    }
    function submitSelection() {
      var data = [];
      for (var i = 0; i < startParam.seats.length; i++) {
        var day = [];
        for (let [key, value] of startParam.sel) {
          if (value.includes(i))
            day.push(key);
        }
        data.push(day.join(','));
      }
      data.unshift(''+startParam.msgid);

      Telegram.WebApp.sendData(data.join('|'));
    }
    function displaySeats() {
      const table = document.createElement('table');
      const tbody = document.createElement('tbody');
      table.classList.add('seats');
      table.appendChild(tbody);
      startParam.sel = new Map();
      startParam.held = new Map();
      let sel = startParam.sel;
      let hld = startParam.held;

      var seats = startParam.seats;
      for (let i in seats)
        seats[i] = seats[i].split("\n");
      var scheme = seats[0], width = 0, rows = 0, total = 0;
      for (let i in scheme)
        width = Math.max(width, scheme[i].length);
      for (let i in scheme) {
        const tr = document.createElement('tr');
        var count = 0;
        if (scheme[i].length < width)
          scheme[i] = scheme[i].padEnd(width);
        for (let j in scheme[i]) {
          const td = addCell(scheme[i][j] == ' ' ? ' ' : ''+count);
          if (scheme[i][j] != ' ') {
            for (var k = 0; k < seats.length; k++) {
              if (seats[k][i][j] == 'S') {
                if (sel.has(total))
                  sel.get(total).push(k);
                else
                  sel.set(total, [k]);
              } else if (seats[k][i][j] == 'H') {
                if (hld.has(total))
                  hld.get(total).push(k);
                else
                  hld.set(total, [k]);
              }
            }
            td.classList.add('seat');
            td.setAttribute('data-id', total++);
            count++;
          } else {
            if ((i == 1 && j == 2) || (i == 1 && j == 12) || (i == 8 && j == 2) || (i == 8 && j == 12))
              td.getElementsByTagName('span')[0].classList.add('wall');
          }
          tr.appendChild(td);
        }
        if (count) {
          var td = addCell(''+(rows+1));
          td.classList.add('row', 'rownum');
          tr.prepend(td);
          var st = tr.children;
          for (var j = 0; j < st.length; j++) {
            var n = parseInt(st[j].children[0].children[0].textContent);
            if (!(st[j].classList.contains('rownum')) && !isNaN(n)) {
              st[j].children[0].children[0].textContent = ''+(count - n);
              st[j].setAttribute('data-row', rows+1);
            }
            st[j].classList.add('row');
          }
          td = addCell(''+(rows+1));
          td.classList.add('row', 'rownum');
          tr.appendChild(td);
          rows++;
        }
        tbody.appendChild(tr);
      }
      var td = document.createElement('td');
      td.textContent = '–†—è–¥';
      td.classList.add('rownumtitle');
      tbody.children[0].prepend(td);
      td = document.createElement('td');
      td.textContent = '–†—è–¥';
      td.classList.add('rownumtitle');
      tbody.children[0].appendChild(td);

      var div = document.createElement('div');
      const btn = document.createElement('button');
      const pr = document.createElement('p');
      div.classList.add('top');
      div.textContent = (startParam.reserve ? 'üí∫ –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ—Å—Ç –≤ –∑–∞–ª–µ' : 'üí∫ –í—ã–±–æ—Ä –º–µ—Å—Ç –≤ –∑–∞–ª–µ');
      if (startParam.reserve && startParam.seats.length > 1) {
        const sl = document.createElement('select');
        sl.setAttribute('id', 'day');
        var opt = document.createElement('option');
        opt.setAttribute('value', -1);
        opt.textContent = '–ù–∞ –≤—Å–µ –¥–Ω–∏ (—Å–æ–≤–º–µ—â–µ–Ω–∏–µ)';
        sl.appendChild(opt);
        for (var i = 0; i < startParam.seats.length; i++) {
          opt = document.createElement('option');
          opt.setAttribute('value', i);
          opt.textContent = '–î–µ–Ω—å ' + (i + 1);
          sl.appendChild(opt);
        }
        sl.addEventListener("change", updateSelected);
        div.appendChild(sl);
      }
      btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
      btn.addEventListener("click", submitSelection);
      div.appendChild(btn);
      pr.setAttribute('id', 'selection');
      div.appendChild(pr);

      document.getElementsByTagName('body')[0].innerHTML = '';

      const wrp = document.createElement('div');
      const wrp2 = document.createElement('div');
      wrp.classList.add('wrapper');

      document.body.appendChild(div);

      var div = document.createElement('div');
      div.classList.add('scene');
      div.textContent = '–°—Ü–µ–Ω–∞';
      wrp2.appendChild(div);
      var scene = div;
      div = document.createElement('div');
      div.classList.add('sound');
      div.textContent = '–ó–≤—É–∫–æ–æ–ø–µ—Ä–∞—Ç–æ—Ä';
      wrp2.appendChild(div);
      var sound = div;

      wrp2.appendChild(table);
      wrp.appendChild(wrp2);
      document.body.appendChild(wrp);
      updateSelected();

      const obs1 = (new ResizeObserver(e => {
        var wr = wrp.getClientRects()[0];
        var w2 = wrp2.getClientRects()[0];
        wrp2.style.width = (wr.height > wr.width ? `${Math.floor((wr.height - 19) * w2.width / w2.height)}px` : '');
      })).observe(wrp);
      const obs2 = (new ResizeObserver(e => {
        var rect = document.querySelectorAll('[data-id="136"]')[0].getClientRects()[0];
        sound.style['margin-left'] = `${Math.floor(rect.width * 3.4)}px`;
        sound.style['margin-top'] = `${Math.floor(rect.height * 13)}px`;
        sound.style.width = `${Math.floor(rect.width * 5)}px`;
        sound.style.height = `${Math.floor(rect.height * 2)}px`;
      })).observe(table);
    }
    function onWindowLoad() {
        window.startParam = (new URLSearchParams(location.hash.substr(1))).get("tgWebAppStartParam");
        startParam = JSON.parse(atob(startParam));

        if (startParam.seats)
          displaySeats();
    }
    </script>
</head>

<body onload="onWindowLoad()">

<table class="init">
  <tr>
    <td>
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </td>
  </tr>
</table>

</body>
</html>
